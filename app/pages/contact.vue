<template>
  <div>
    <div class="flex items-end justify-between gap-4 flex-wrap">
      <div>
        <h1 class="text-4xl sm:text-5xl font-bold text-slate-700 tracking-tight">
          ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤
        </h1>
        <p class="mt-2 text-sm text-slate-500">
          ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏≤‡πÄ‡∏£‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡πá‡∏ß
        </p>
      </div>

      <button
        class="inline-flex items-center gap-2 px-3 py-2 rounded-md border border-slate-200 hover:bg-slate-50 text-sm"
        type="button"
        @click="resetForm"
      >
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
      </button>
    </div>

    <div class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="lg:col-span-2">
        <div class="bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden">
          <div class="p-5 sm:p-6 border-b border-slate-100">
            <h2 class="text-lg font-bold text-slate-800">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° / ‡∏Ç‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</h2>
            <p class="mt-1 text-sm text-slate-500">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
          </div>

          <div class="p-5 sm:p-6">
            <div v-if="success" class="mb-5 p-4 rounded-lg border border-green-200 bg-green-50 text-green-800 text-sm">
              ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏±‡∏ö/‡∏Ñ‡πà‡∏∞
            </div>

            <div v-if="error" class="mb-5 p-4 rounded-lg border border-red-200 bg-red-50 text-red-800 text-sm">
              {{ error }}
            </div>

            <form class="space-y-5" @submit.prevent="submit">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold text-slate-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• *</label>
                  <input
                    v-model.trim="form.full_name"
                    type="text"
                    class="mt-2 w-full h-11 px-4 rounded-md border border-slate-300 focus:outline-none focus:ring-2 focus:ring-red-200 focus:border-red-300"
                    placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤"
                    required
                  />
                </div>

                <div>
                  <label class="block text-sm font-semibold text-slate-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£</label>
                  <input
                    v-model.trim="form.phone"
                    type="tel"
                    class="mt-2 w-full h-11 px-4 rounded-md border border-slate-300 focus:outline-none focus:ring-2 focus:ring-red-200 focus:border-red-300"
                    placeholder="‡πÄ‡∏ä‡πà‡∏ô 08x-xxx-xxxx"
                  />
                </div>

                <div>
                  <label class="block text-sm font-semibold text-slate-700">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</label>
                  <input
                    v-model.trim="form.company"
                    type="text"
                    class="mt-2 w-full h-11 px-4 rounded-md border border-slate-300 focus:outline-none focus:ring-2 focus:ring-red-200 focus:border-red-300"
                    placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"
                  />
                </div>

                <div>
                  <label class="block text-sm font-semibold text-slate-700">Email</label>
                  <input
                    v-model.trim="form.email"
                    type="email"
                    class="mt-2 w-full h-11 px-4 rounded-md border border-slate-300 focus:outline-none focus:ring-2 focus:ring-red-200 focus:border-red-300"
                    placeholder="name@company.com"
                  />
                </div>
              </div>

              <div>
                <label class="block text-sm font-semibold text-slate-700">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠</label>
                <input
                  v-model.trim="form.subject"
                  type="text"
                  class="mt-2 w-full h-11 px-4 rounded-md border border-slate-300 focus:outline-none focus:ring-2 focus:ring-red-200 focus:border-red-300"
                  placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡∏≠‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏Ñ‡∏≠‡∏£‡πå‡∏™"
                />
              </div>

              <div>
                <label class="block text-sm font-semibold text-slate-700">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î *</label>
                <textarea
                  v-model.trim="form.detail"
                  rows="6"
                  class="mt-2 w-full px-4 py-3 rounded-md border border-slate-300 focus:outline-none focus:ring-2 focus:ring-red-200 focus:border-red-300"
                  placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏ä‡πà‡∏ß‡∏¢..."
                  required
                />
                <div class="mt-2 text-xs text-slate-500">
                  ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤/‡∏£‡∏∏‡πà‡∏ô, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô, ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏î‡∏ß‡∏Å‡πÉ‡∏´‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö
                </div>
              </div>

              <div class="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
                <div class="text-xs text-slate-500">
                  ‡∏Å‡∏î‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏¢‡∏¥‡∏ô‡∏¢‡∏≠‡∏°‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö
                </div>

                <button
                  class="inline-flex items-center justify-center gap-2 h-11 px-5 rounded-md bg-red-600 text-white font-bold hover:bg-red-700 active:bg-red-800 disabled:opacity-60 disabled:cursor-not-allowed"
                  :disabled="loading"
                  type="submit"
                >
                  <span v-if="loading" class="loading loading-spinner loading-sm"></span>
                  ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="lg:col-span-1">
        <div class="bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden">
          <div class="p-5 sm:p-6 border-b border-slate-100">
            <h2 class="text-lg font-bold text-slate-800">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</h2>
            <p class="mt-1 text-sm text-slate-500">‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ‡πÄ‡∏≠‡πá‡∏°‡πÅ‡∏≠‡∏ô‡∏î‡πå‡∏ö‡∏µ ‡∏≠‡∏¥‡∏ô‡πÇ‡∏ô‡πÄ‡∏ß‡∏ó‡∏µ‡∏ü ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏¥‡∏£‡πå‡∏ã ‡∏à‡∏≥‡∏Å‡∏±‡∏î</p>
            <p class="mt-1 text-sm text-slate-500">M&B INNOVATIVE COMMERCE Co., Ltd.</p>
          </div>

          <div class="p-5 sm:p-6 space-y-4 text-sm text-slate-700">
            <div class="flex items-start gap-3">
              <span class="mt-0.5 inline-flex h-8 w-8 items-center justify-center rounded-md bg-red-50 text-red-700 border border-red-100">üìç</span>
              <div>
                <div class="font-semibold">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</div>
                <div class="text-slate-600">‡∏≠.‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏à.‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î 450000</div>
              </div>
            </div>

            <div class="flex items-start gap-3">
              <span class="mt-0.5 inline-flex h-8 w-8 items-center justify-center rounded-md bg-red-50 text-red-700 border border-red-100">‚òé</span>
              <div>
                <div class="font-semibold">‡πÇ‡∏ó‡∏£</div>
                <div class="text-slate-600">0917762859</div>
              </div>
            </div>

            <div class="flex items-start gap-3">
              <span class="mt-0.5 inline-flex h-8 w-8 items-center justify-center rounded-md bg-red-50 text-red-700 border border-red-100">‚úâ</span>
              <div>
                <div class="font-semibold">‡∏≠‡∏µ‡πÄ‡∏°‡∏•</div>
                <div class="text-slate-600">automation101training@gmail.com</div>
              </div>
            </div>

            <div class="pt-2">
              <div class="text-xs font-semibold text-slate-500 mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£</div>
              <div class="text-slate-600">‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå-‡∏®‡∏∏‡∏Å‡∏£‡πå 09:00-18:00</div>
            </div>

            <div class="pt-3 border-t border-slate-100">
              <button
                class="w-full inline-flex items-center justify-center gap-2 h-11 px-4 rounded-md border border-slate-200 hover:bg-slate-50 font-semibold text-slate-700"
                type="button"
                @click="goInvoice"
              >
                ‡∏Ç‡∏≠‡πÉ‡∏ö‡πÄ‡∏™‡∏ô‡∏≠‡∏£‡∏≤‡∏Ñ‡∏≤ (‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ Invoice)
                <span class="text-red-600">‚Üí</span>
              </button>
            </div>
          </div>
        </div>

        <div class="mt-6 bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden">
          <div class="p-5 sm:p-6 border-b border-slate-100">
            <h2 class="text-lg font-bold text-slate-800">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà</h2>
          </div>
          <div class="p-3">
            <div class="aspect-[16/9] rounded-md bg-slate-50 border border-slate-200 flex items-center justify-center text-slate-500 text-sm">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
const route = useRoute()
useState<string>("mb_search_q", () => "")

type ContactForm = {
  full_name: string
  phone: string
  company: string
  email: string
  subject: string
  detail: string
}

type ContactMessageRow = ContactForm & {
  id: string
  source_page: string
  created_at: string
}

const CONTACT_STORAGE_KEY = "contact_messages"
const { getValue, setValue } = useSharedStore()

const form = ref<ContactForm>({
  full_name: "",
  phone: "",
  company: "",
  email: "",
  subject: "",
  detail: "",
})

const loading = ref(false)
const error = ref("")
const success = ref(false)

const nowIso = () => new Date().toISOString()

const uid = () => {
  if (typeof globalThis !== "undefined" && (globalThis as any).crypto?.randomUUID) {
    return (globalThis as any).crypto.randomUUID() as string
  }
  return `c_${Math.random().toString(16).slice(2)}_${Date.now()}`
}

const resetForm = () => {
  form.value = {
    full_name: "",
    phone: "",
    company: "",
    email: "",
    subject: "",
    detail: "",
  }
  error.value = ""
  success.value = false
}

const submit = async () => {
  loading.value = true
  error.value = ""
  success.value = false

  try {
    const fullName = (form.value.full_name || "").trim()
    const detail = (form.value.detail || "").trim()

    if (!fullName) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•")
    if (!detail) throw new Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î")

    const payload: ContactMessageRow = {
      id: uid(),
      full_name: fullName,
      phone: (form.value.phone || "").trim(),
      company: (form.value.company || "").trim(),
      email: (form.value.email || "").trim(),
      subject: (form.value.subject || "").trim(),
      detail,
      source_page: route.fullPath,
      created_at: nowIso(),
    }

    const rows = await getValue<ContactMessageRow>(CONTACT_STORAGE_KEY)
    rows.unshift(payload)
    await setValue<ContactMessageRow>(CONTACT_STORAGE_KEY, rows)

    resetForm()
    success.value = true
  } catch (err: any) {
    error.value = err?.message || "‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à"
  } finally {
    loading.value = false
  }
}

const goInvoice = async () => {
  await navigateTo("/invoice")
}
</script>

<style scoped>
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>
